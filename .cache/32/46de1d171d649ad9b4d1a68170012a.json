{"id":"../node_modules/3id-did-provider/lib/did-provider.js","dependencies":[{"name":"/home/vitalpointai/projects/space-gems/node_modules/3id-did-provider/lib/did-provider.js.map","includedInParent":true,"mtime":1642262883137},{"name":"/home/vitalpointai/projects/space-gems/node_modules/3id-did-provider/src/did-provider.ts","includedInParent":true,"mtime":1642262883137},{"name":"/home/vitalpointai/projects/space-gems/package.json","includedInParent":true,"mtime":1642266346920},{"name":"/home/vitalpointai/projects/space-gems/node_modules/3id-did-provider/package.json","includedInParent":true,"mtime":1642262883137},{"name":"/home/vitalpointai/projects/space-gems/node_modules/3id-did-provider/.babelrc","includedInParent":true,"mtime":1642262883137},{"name":"dag-jose-utils","loc":{"line":13,"column":33},"parent":"/home/vitalpointai/projects/space-gems/node_modules/3id-did-provider/lib/did-provider.js","resolved":"/home/vitalpointai/projects/space-gems/node_modules/dag-jose-utils/lib/index.js"},{"name":"did-jwt","loc":{"line":14,"column":26},"parent":"/home/vitalpointai/projects/space-gems/node_modules/3id-did-provider/lib/did-provider.js","resolved":"/home/vitalpointai/projects/space-gems/node_modules/did-jwt/lib/index.module.js"},{"name":"rpc-utils","loc":{"line":15,"column":28},"parent":"/home/vitalpointai/projects/space-gems/node_modules/3id-did-provider/lib/did-provider.js","resolved":"/home/vitalpointai/projects/space-gems/node_modules/rpc-utils/dist/rpc-utils.esm.js"},{"name":"./utils","loc":{"line":16,"column":24},"parent":"/home/vitalpointai/projects/space-gems/node_modules/3id-did-provider/lib/did-provider.js","resolved":"/home/vitalpointai/projects/space-gems/node_modules/3id-did-provider/lib/utils.js"}],"generated":{"js":"\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.DidProvider = exports.didMethods = void 0;\nconst dag_jose_utils_1 = require(\"dag-jose-utils\");\nconst did_jwt_1 = require(\"did-jwt\");\nconst rpc_utils_1 = require(\"rpc-utils\");\nconst utils_1 = require(\"./utils\");\nfunction toGeneralJWS(jws) {\n    const [protectedHeader, payload, signature] = jws.split('.');\n    return {\n        payload,\n        signatures: [{ protected: protectedHeader, signature }],\n    };\n}\nfunction sign(payload, didWithFragment, keyring, threeIdx, protectedHeader = {}, revocable) {\n    return __awaiter(this, void 0, void 0, function* () {\n        let [did, keyFragment] = didWithFragment.split('#');\n        let kid, signer;\n        if (did.startsWith('did:key:')) {\n            const pubkey = did.split(':')[2];\n            kid = `${did}#${pubkey}`;\n            signer = keyring.getMgmtSigner(pubkey);\n        }\n        else {\n            if (did !== threeIdx.id)\n                throw new Error(`Unknown DID: ${did}`);\n            const version = threeIdx.get3idVersion();\n            if (!keyFragment)\n                keyFragment = keyring.getKeyFragment(version);\n            kid = `${did}${revocable ? '' : `?version-id=${version}`}#${keyFragment}`;\n            signer = keyring.getSigner(version);\n        }\n        const header = utils_1.toStableObject(Object.assign(protectedHeader, { kid }));\n        const jws = yield did_jwt_1.createJWS(utils_1.toStableObject(payload), signer, header);\n        return toGeneralJWS(jws);\n    });\n}\nexports.didMethods = {\n    did_authenticate: ({ permissions, keyring, threeIdx, origin, forcedDID }, params) => __awaiter(void 0, void 0, void 0, function* () {\n        const paths = yield permissions.request(origin, params.paths || []);\n        if (paths === null)\n            throw new rpc_utils_1.RPCError(4001, 'User Rejected Request');\n        return sign({\n            did: forcedDID || threeIdx.id,\n            aud: params.aud,\n            nonce: params.nonce,\n            paths,\n            exp: Math.floor(Date.now() / 1000) + 600,\n        }, forcedDID || threeIdx.id, keyring, threeIdx);\n    }),\n    did_createJWS: ({ permissions, keyring, threeIdx, origin }, params) => __awaiter(void 0, void 0, void 0, function* () {\n        if (!permissions.has(origin))\n            throw new rpc_utils_1.RPCError(4100, 'Unauthorized');\n        const jws = yield sign(params.payload, params.did, keyring, threeIdx, params.protected, params.revocable);\n        return { jws };\n    }),\n    did_decryptJWE: ({ permissions, keyring, origin }, params) => __awaiter(void 0, void 0, void 0, function* () {\n        if (!permissions.has(origin))\n            throw new rpc_utils_1.RPCError(4100, 'Unauthorized');\n        const parsedKids = utils_1.parseJWEKids(params.jwe);\n        const decrypter = keyring.getAsymDecrypter(parsedKids);\n        const bytes = yield did_jwt_1.decryptJWE(params.jwe, decrypter);\n        let obj;\n        try {\n            obj = dag_jose_utils_1.decodeCleartext(bytes);\n        }\n        catch (e) {\n        }\n        if (obj && !permissions.has(origin, obj.paths))\n            throw new rpc_utils_1.RPCError(4100, 'Unauthorized');\n        return { cleartext: utils_1.encodeBase64(bytes) };\n    }),\n};\nclass DidProvider {\n    constructor({ permissions, threeIdx, keyring, forcedOrigin, forcedDID }) {\n        const handler = rpc_utils_1.createHandler(exports.didMethods);\n        this._handle = (origin, msg) => __awaiter(this, void 0, void 0, function* () {\n            return yield handler({\n                origin: forcedOrigin !== null && forcedOrigin !== void 0 ? forcedOrigin : origin,\n                permissions,\n                threeIdx,\n                keyring,\n                forcedDID,\n            }, msg);\n        });\n    }\n    get isDidProvider() {\n        return true;\n    }\n    send(msg, origin) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return yield this._handle(origin !== null && origin !== void 0 ? origin : '', msg);\n        });\n    }\n}\nexports.DidProvider = DidProvider;\n"},"sourceMaps":{"js":{"version":3,"file":"did-provider.js","sourceRoot":"","sources":["../src/did-provider.ts"],"names":[],"mappings":"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","sourcesContent":["import { decodeCleartext } from 'dag-jose-utils'\nimport { createJWS, decryptJWE } from 'did-jwt'\nimport type {\n  AuthParams,\n  CreateJWSParams,\n  DecryptJWEParams,\n  DIDMethodName,\n  DIDProvider,\n  DIDProviderMethods,\n  GeneralJWS,\n} from 'dids'\nimport { HandlerMethods, RPCError, createHandler } from 'rpc-utils'\nimport type { RPCRequest, RPCResponse } from 'rpc-utils'\n\nimport Keyring from './keyring'\nimport { ThreeIDX } from './three-idx'\nimport Permissions from './permissions'\nimport { toStableObject, encodeBase64, parseJWEKids } from './utils'\n\ntype Origin = string | null | undefined\n\nexport type Context = {\n  permissions: Permissions\n  threeIdx: ThreeIDX\n  keyring: Keyring\n  origin: Origin\n  forcedDID?: string\n}\n\nfunction toGeneralJWS(jws: string): GeneralJWS {\n  const [protectedHeader, payload, signature] = jws.split('.')\n  return {\n    payload,\n    signatures: [{ protected: protectedHeader, signature }],\n  }\n}\n\nasync function sign(\n  payload: Record<string, any>,\n  didWithFragment: string,\n  keyring: Keyring,\n  threeIdx: ThreeIDX,\n  protectedHeader: Record<string, any> = {},\n  revocable?: boolean\n): Promise<GeneralJWS> {\n  let [did, keyFragment] = didWithFragment.split('#') // eslint-disable-line prefer-const\n  let kid, signer\n  if (did.startsWith('did:key:')) {\n    const pubkey = did.split(':')[2]\n    kid = `${did}#${pubkey}`\n    signer = keyring.getMgmtSigner(pubkey)\n  } else {\n    if (did !== threeIdx.id) throw new Error(`Unknown DID: ${did}`)\n    const version = threeIdx.get3idVersion()\n    if (!keyFragment) keyFragment = keyring.getKeyFragment(version)\n    kid = `${did}${revocable ? '' : `?version-id=${version}`}#${keyFragment}`\n    signer = keyring.getSigner(version)\n  }\n  const header = toStableObject(Object.assign(protectedHeader, { kid }))\n  const jws = await createJWS(toStableObject(payload), signer, header)\n  return toGeneralJWS(jws)\n}\n\nexport const didMethods: HandlerMethods<Context, DIDProviderMethods> = {\n  did_authenticate: async (\n    { permissions, keyring, threeIdx, origin, forcedDID },\n    params: AuthParams\n  ) => {\n    const paths = await permissions.request(origin, params.paths || [])\n    // paths should be an array if permission granted\n    // may be a subset or requested paths or empty array\n    if (paths === null) throw new RPCError(4001, 'User Rejected Request')\n    return sign(\n      {\n        did: forcedDID || threeIdx.id,\n        aud: params.aud,\n        nonce: params.nonce,\n        paths,\n        exp: Math.floor(Date.now() / 1000) + 600, // expires 10 min from now\n      },\n      forcedDID || threeIdx.id,\n      keyring,\n      threeIdx\n    )\n  },\n  did_createJWS: async (\n    { permissions, keyring, threeIdx, origin },\n    params: CreateJWSParams & { did: string; revocable?: boolean }\n  ) => {\n    if (!permissions.has(origin)) throw new RPCError(4100, 'Unauthorized')\n    // TODO - if the requesting DID is our management key\n    // (did:key) we should request explicit permission.\n    const jws = await sign(\n      params.payload,\n      params.did,\n      keyring,\n      threeIdx,\n      params.protected,\n      params.revocable\n    )\n    return { jws }\n  },\n  did_decryptJWE: async ({ permissions, keyring, origin }, params: DecryptJWEParams) => {\n    if (!permissions.has(origin)) throw new RPCError(4100, 'Unauthorized')\n    const parsedKids = parseJWEKids(params.jwe)\n    const decrypter = keyring.getAsymDecrypter(parsedKids)\n    const bytes = await decryptJWE(params.jwe, decrypter)\n    let obj\n    try {\n      obj = decodeCleartext(bytes)\n    } catch (e) {\n      // There was an error decoding, which means that this is not a cleartext encoded as a CID\n      // TODO - We should explicitly ask for permission.\n    }\n    if (obj && !permissions.has(origin, obj.paths)) throw new RPCError(4100, 'Unauthorized')\n    return { cleartext: encodeBase64(bytes) }\n  },\n}\n\nexport interface ProviderConfig {\n  permissions: Permissions\n  threeIdx: ThreeIDX\n  keyring: Keyring\n  forcedOrigin?: string\n  forcedDID?: string\n}\n\ntype HandleMethod = <Name extends DIDMethodName>(\n  origin: string,\n  msg: RPCRequest<DIDProviderMethods, Name>\n) => Promise<RPCResponse<DIDProviderMethods, Name> | null>\n\nexport class DidProvider implements DIDProvider {\n  _handle: HandleMethod\n\n  constructor({ permissions, threeIdx, keyring, forcedOrigin, forcedDID }: ProviderConfig) {\n    const handler = createHandler<Context, DIDProviderMethods>(didMethods)\n    this._handle = async <Name extends DIDMethodName>(\n      origin: string,\n      msg: RPCRequest<DIDProviderMethods, Name>\n    ): Promise<RPCResponse<DIDProviderMethods, Name> | null> => {\n      return await handler(\n        {\n          origin: forcedOrigin ?? origin,\n          permissions,\n          threeIdx,\n          keyring,\n          forcedDID,\n        },\n        msg\n      )\n    }\n  }\n\n  get isDidProvider(): boolean {\n    return true\n  }\n\n  async send<Name extends DIDMethodName>(\n    msg: RPCRequest<DIDProviderMethods, Name>,\n    origin?: Origin\n  ): Promise<RPCResponse<DIDProviderMethods, Name> | null> {\n    return await this._handle(origin ?? '', msg)\n  }\n}\n"]}},"error":null,"hash":"087d2c52848f26e3c577719f85eec08c","cacheData":{"env":{}}}