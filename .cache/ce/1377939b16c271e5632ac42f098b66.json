{"id":"../node_modules/dids/lib/did.js","dependencies":[{"name":"/home/vitalpointai/projects/space-gems/node_modules/dids/lib/did.js.map","includedInParent":true,"mtime":1642262883150},{"name":"/home/vitalpointai/projects/space-gems/package.json","includedInParent":true,"mtime":1642266346920},{"name":"/home/vitalpointai/projects/space-gems/node_modules/dids/package.json","includedInParent":true,"mtime":1642262883150},{"name":"did-resolver","loc":{"line":13,"column":31},"parent":"/home/vitalpointai/projects/space-gems/node_modules/dids/lib/did.js","resolved":"/home/vitalpointai/projects/space-gems/node_modules/did-resolver/lib/resolver.module.js"},{"name":"did-jwt","loc":{"line":14,"column":26},"parent":"/home/vitalpointai/projects/space-gems/node_modules/dids/lib/did.js","resolved":"/home/vitalpointai/projects/space-gems/node_modules/did-jwt/lib/index.module.js"},{"name":"dag-jose-utils","loc":{"line":15,"column":33},"parent":"/home/vitalpointai/projects/space-gems/node_modules/dids/lib/did.js","resolved":"/home/vitalpointai/projects/space-gems/node_modules/dag-jose-utils/lib/index.js"},{"name":"rpc-utils","loc":{"line":16,"column":28},"parent":"/home/vitalpointai/projects/space-gems/node_modules/dids/lib/did.js","resolved":"/home/vitalpointai/projects/space-gems/node_modules/rpc-utils/dist/rpc-utils.esm.js"},{"name":"./utils","loc":{"line":17,"column":24},"parent":"/home/vitalpointai/projects/space-gems/node_modules/dids/lib/did.js","resolved":"/home/vitalpointai/projects/space-gems/node_modules/dids/lib/utils.js"}],"generated":{"js":"\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.DID = void 0;\nconst did_resolver_1 = require(\"did-resolver\");\nconst did_jwt_1 = require(\"did-jwt\");\nconst dag_jose_utils_1 = require(\"dag-jose-utils\");\nconst rpc_utils_1 = require(\"rpc-utils\");\nconst utils_1 = require(\"./utils\");\nfunction isResolver(resolver) {\n    return 'registry' in resolver && 'cache' in resolver;\n}\nclass DID {\n    constructor({ provider, resolver = {}, resolverOptions } = {}) {\n        if (provider != null) {\n            this._client = new rpc_utils_1.RPCClient(provider);\n        }\n        this.setResolver(resolver, resolverOptions);\n    }\n    get authenticated() {\n        return this._id != null;\n    }\n    get id() {\n        if (this._id == null) {\n            throw new Error('DID is not authenticated');\n        }\n        return this._id;\n    }\n    setProvider(provider) {\n        if (this._client == null) {\n            this._client = new rpc_utils_1.RPCClient(provider);\n        }\n        else if (this._client.connection !== provider) {\n            throw new Error('A different provider is already set, create a new DID instance to use another provider');\n        }\n    }\n    setResolver(resolver, resolverOptions) {\n        this._resolver = isResolver(resolver) ? resolver : new did_resolver_1.Resolver(resolver, resolverOptions);\n    }\n    authenticate({ provider, paths = [], aud } = {}) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (provider != null) {\n                this.setProvider(provider);\n            }\n            if (this._client == null) {\n                throw new Error('No provider available');\n            }\n            const nonce = utils_1.randomString();\n            const jws = yield this._client.request('did_authenticate', {\n                nonce,\n                aud,\n                paths,\n            });\n            const { kid } = yield this.verifyJWS(jws);\n            const payload = utils_1.base64urlToJSON(jws.payload);\n            if (!kid.includes(payload.did))\n                throw new Error('Invalid authencation response, kid mismatch');\n            if (payload.nonce !== nonce)\n                throw new Error('Invalid authencation response, wrong nonce');\n            if (payload.aud !== aud)\n                throw new Error('Invalid authencation response, wrong aud');\n            if (payload.exp < Date.now() / 1000)\n                throw new Error('Invalid authencation response, expired');\n            this._id = payload.did;\n            return this._id;\n        });\n    }\n    createJWS(payload, options = {}) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (this._client == null)\n                throw new Error('No provider available');\n            if (this._id == null)\n                throw new Error('DID is not authenticated');\n            const { jws } = yield this._client.request('did_createJWS', Object.assign(Object.assign({ did: this._id }, options), { payload }));\n            return jws;\n        });\n    }\n    createDagJWS(payload, options = {}) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const { cid, linkedBlock } = yield dag_jose_utils_1.encodePayload(payload);\n            const payloadCid = utils_1.encodeBase64Url(cid.bytes);\n            Object.assign(options, { linkedBlock: utils_1.encodeBase64(linkedBlock) });\n            const jws = yield this.createJWS(payloadCid, options);\n            jws.link = cid;\n            return { jws, linkedBlock };\n        });\n    }\n    verifyJWS(jws, options = {}) {\n        var _a, _b, _c, _d, _e;\n        return __awaiter(this, void 0, void 0, function* () {\n            if (typeof jws !== 'string')\n                jws = utils_1.fromDagJWS(jws);\n            const kid = utils_1.base64urlToJSON(jws.split('.')[0]).kid;\n            if (!kid)\n                throw new Error('No \"kid\" found in jws');\n            const didResolutionResult = yield this.resolve(kid);\n            const timecheckEnabled = !options.disableTimecheck;\n            if (timecheckEnabled) {\n                const nextUpdate = (_a = didResolutionResult.didDocumentMetadata) === null || _a === void 0 ? void 0 : _a.nextUpdate;\n                if (nextUpdate) {\n                    const isEarlier = options.atTime && options.atTime < new Date(nextUpdate).valueOf();\n                    const isLater = !isEarlier;\n                    if (isLater) {\n                        throw new Error(`invalid_jws: signature authored with a revoked DID version: ${kid}`);\n                    }\n                }\n                const updated = (_b = didResolutionResult.didDocumentMetadata) === null || _b === void 0 ? void 0 : _b.updated;\n                if (updated && options.atTime && options.atTime < new Date(updated).valueOf()) {\n                    throw new Error(`invalid_jws: signature authored before creation of DID version: ${kid}`);\n                }\n            }\n            const signerDid = (_c = didResolutionResult.didDocument) === null || _c === void 0 ? void 0 : _c.id;\n            if (options.issuer && options.issuer !== signerDid) {\n                const issuerUrl = utils_1.didWithTime(options.issuer, options.atTime);\n                const issuerResolution = yield this.resolve(issuerUrl);\n                const controllerProperty = (_d = issuerResolution.didDocument) === null || _d === void 0 ? void 0 : _d.controller;\n                const controllers = utils_1.extractControllers(controllerProperty);\n                const signerIsController = signerDid ? controllers.includes(signerDid) : false;\n                if (!signerIsController) {\n                    throw new Error(`invalid_jws: not a valid verificationMethod for issuer: ${kid}`);\n                }\n            }\n            const publicKeys = ((_e = didResolutionResult.didDocument) === null || _e === void 0 ? void 0 : _e.verificationMethod) || [];\n            did_jwt_1.verifyJWS(jws, publicKeys);\n            let payload;\n            try {\n                payload = utils_1.base64urlToJSON(jws.split('.')[1]);\n            }\n            catch (e) {\n            }\n            return { kid, payload, didResolutionResult };\n        });\n    }\n    createJWE(cleartext, recipients, options = {}) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const encrypters = yield did_jwt_1.resolveX25519Encrypters(recipients, this._resolver);\n            return did_jwt_1.createJWE(cleartext, encrypters, options.protectedHeader, options.aad);\n        });\n    }\n    createDagJWE(cleartext, recipients, options = {}) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return this.createJWE(dag_jose_utils_1.prepareCleartext(cleartext), recipients, options);\n        });\n    }\n    decryptJWE(jwe, options = {}) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (this._client == null)\n                throw new Error('No provider available');\n            if (this._id == null)\n                throw new Error('DID is not authenticated');\n            const { cleartext } = yield this._client.request('did_decryptJWE', Object.assign(Object.assign({ did: this._id }, options), { jwe }));\n            return utils_1.decodeBase64(cleartext);\n        });\n    }\n    decryptDagJWE(jwe) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const bytes = yield this.decryptJWE(jwe);\n            return dag_jose_utils_1.decodeCleartext(bytes);\n        });\n    }\n    resolve(didUrl) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const result = yield this._resolver.resolve(didUrl);\n            if (result.didResolutionMetadata.error) {\n                const { error, message } = result.didResolutionMetadata;\n                const maybeMessage = message ? `, ${message}` : '';\n                throw new Error(`Failed to resolve ${didUrl}: ${error}${maybeMessage}`);\n            }\n            return result;\n        });\n    }\n}\nexports.DID = DID;\n"},"sourceMaps":{"js":{"version":3,"file":"did.js","sourceRoot":"","sources":["../src/did.ts"],"names":[],"mappings":"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","sourcesContent":[null]}},"error":null,"hash":"fe64dac11a62d0752a02c8e3232fa5ca","cacheData":{"env":{}}}